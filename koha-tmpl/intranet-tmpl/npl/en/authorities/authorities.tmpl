<!-- TMPL_INCLUDE NAME="doc-head-open.inc" -->NEULIS -- Authorities
<!-- TMPL_INCLUDE NAME="doc-head-close-addbiblio.inc" -->
<!--TMPL_UNLESS NAME="nonav"--><!-- TMPL_INCLUDE NAME="masthead.inc" --><!--/TMPL_UNLESS-->
<!-- TMPL_INCLUDE NAME="authorities-topmenu.inc" -->
<!--TMPL_UNLESS NAME="nonav"--><!-- TMPL_INCLUDE NAME="intranet-nav-brief.inc" --><!--/TMPL_UNLESS-->


<link rel="stylesheet" type="text/css" href="<!-- TMPL_VAR NAME="themelang" -->/includes/marc-editor.css">
<div id="main">
<form method="post" name="f" id="f" action="authorities.pl?authid=<!-- TMPL_VAR NAME="authid" -->&nonav=<!-- TMPL_VAR NAME="nonav" -->&linkid="+document.form.f.linkid.value >
	
<div class="tabitem">
	<h1>Authority number <!-- TMPL_VAR NAME="authid" --></h1>
	<p><input type="hidden" name="nonav" value="<!-- TMPL_VAR NAME="nonav" -->"><input type="hidden" name="index" value="<!-- TMPL_VAR NAME="index" -->">
		<input type="hidden" name="op" value="add">
		<input type="hidden" name="addfield_field">
		<input type="hidden" name="authtypecode" value="<!-- TMPL_VAR NAME="authtypecode" -->">
		<input type="hidden" name="authid" value="<!-- TMPL_VAR NAME="authid" -->">
	<input type="hidden" name="linkid" id="linkid" value="0000">
		<!-- TMPL_IF name="authid" -->
			<input type="button" value="Save" onClick="Check(this.form)" accesskey="w" class="button authority">
		<!-- TMPL_ELSE -->
			<input type="button" value="Add authority" onClick="Check(this.form)" accesskey="w" class="button authority">
		<!-- /TMPL_IF -->
	</p>
</div>
<div name="0XX" id="0XX" class="tab" style="visibility:visible">
<!-- TMPL_IF name="duplicateauthid" -->
			<div class="error">
				<p>Is this a duplicate of <a href="detail.pl?authid=<!-- TMPL_VAR name="duplicateauthid" -->&nonav=<!-- TMPL_VAR name="nonav" -->" onclick="openWindow('detail.pl?nonav=<!-- TMPL_VAR name="nonav" -->&authid=<!-- TMPL_VAR name="duplicateauthid" -->&popup=1', ''; return false;)"><!-- TMPL_VAR name="duplicateauthvalue" --></a>?</p>
				
				<ul>
					
					<li>If not, click to <input type="hidden" value="0" id="confirm_not_duplicate" name="confirm_not_duplicate" /> <a href="#" onclick="confirmnotdup(); return false;">Confirm it's not a duplicate</a></li>
				</ul>
			</div>
		<!-- /TMPL_IF -->
<!-- TMPL_LOOP NAME="0XX" -->
<!-- TMPL_IF name="tag" -->
<p class="MARCtag">
	<input type="hidden" name="ind_tag" value="<!-- TMPL_VAR NAME="tag" -->">
	<!-- TMPL_UNLESS name="hide_marc" --><a title="<!-- TMPL_VAR NAME="tag_lib" -->"><!-- TMPL_VAR NAME="tag" --></a>
	<input tabindex="1" onblur="this.style.backgroundColor='#ffffff';" onfocus="this.style.backgroundColor='#ffffff;'" type="text" <!-- TMPL_IF NAME="fixedfield" --> style="display:none;" <!-- /TMPL_IF --> name="indicator" size="2" maxlength="2" value="<!-- TMPL_VAR NAME="indicator" -->" class="flat"> -
<!-- TMPL_ELSE -->
<input tabindex="1" type="hidden" <!-- TMPL_IF NAME="fixedfield" --> style="display:none;" <!-- /TMPL_IF --> name="indicator" value="<!-- TMPL_VAR NAME="indicator" -->"><!-- /TMPL_UNLESS -->
	<!-- TMPL_UNLESS NAME="advancedMARCEditor" --><!-- TMPL_VAR NAME="tag_lib" --><!-- /TMPL_UNLESS -->
	<!-- TMPL_IF name="repeatable" --><a href="javascript:AddField('<!-- TMPL_VAR NAME="tag" -->')">+</a><!-- /TMPL_IF -->
</p>
<!-- /TMPL_IF -->
<div><!-- TMPL_LOOP NAME="subfield_loop" -->
<!-- TMPL_IF NAME="visibility" -->
<a tabindex="1" style="color: grey; font-size: 80%; cursor: se-resize;" id="label<!-- TMPL_VAR name="index" -->" onclick="unHideSubfield('subfield<!-- TMPL_VAR NAME="tag" --><!-- TMPL_VAR name="index" -->','label<!-- TMPL_VAR name="index" -->')"><!-- TMPL_VAR NAME="subfield" --></a>
<!-- /TMPL_IF -->
<div style="<!-- TMPL_VAR NAME='visibility' -->;" id="subfield<!-- TMPL_VAR NAME='tag' --><!-- TMPL_VAR NAME='index' -->"><!-- TMPL_UNLESS NAME="advancedMARCEditor" --><label <!-- TMPL_IF NAME="fixedfield" --> style="display:none;" <!-- /TMPL_IF --> class="labelsubfield"> <!-- /TMPL_UNLESS --><!-- TMPL_UNLESS name="hide_marc" --><img <!-- TMPL_IF NAME="fixedfield" --> style="display:none;" <!-- /TMPL_IF --> src="<!-- TMPL_VAR NAME="themelang" -->/images/up.png" onclick="upSubfield('subfield<!-- TMPL_VAR NAME="tag" --><!-- TMPL_VAR name="index" -->')"/><input title="<!-- TMPL_VAR NAME="marc_lib_plain" -->" style=" <!-- TMPL_IF NAME="fixedfield" -->display:none; <!-- /TMPL_IF -->border:0;" type="text" name="subfield" value="<!-- TMPL_VAR NAME="subfield" -->" size="1" maxlength="1" class="flat" DISABLE READONLY tabindex=-1 />
<!-- TMPL_ELSE --><input type="hidden" name="subfield" value="<!-- TMPL_VAR NAME="subfield" -->"/><!-- /TMPL_UNLESS -->
<!-- TMPL_UNLESS NAME="advancedMARCEditor" --><!-- TMPL_IF name="mandatory" --><b><!-- /TMPL_IF --><!-- TMPL_VAR NAME="marc_lib" --><!-- TMPL_IF name="mandatory" --> *</b><!-- /TMPL_IF --></label><!-- /TMPL_UNLESS -->
<!-- TMPL_VAR NAME="marc_value" --><!-- TMPL_IF NAME="repeatable" --><a style="cursor: crosshair; color: grey; font-size: 80%;" onclick="cloneSubfield('subfield<!-- TMPL_VAR NAME="tag" --><!-- TMPL_VAR name="index" -->')">+</a><!-- /TMPL_IF -->
<input type="hidden" name="tag" value="<!-- TMPL_VAR NAME="tag" -->"/>
<input type="hidden" name="subfieldYYY" value="<!-- TMPL_VAR NAME="subfield" -->" size="2" maxlength="1"/>
<input type="hidden" name="mandatory" value="<!-- TMPL_VAR NAME="mandatory" -->"/>
<input type="hidden" name="kohafield" value="<!-- TMPL_VAR NAME="kohafield" -->"/>
<input type="hidden" name="tag_mandatory" value="<!-- TMPL_VAR NAME="tag_mandatory" -->"/>
</div><!-- /TMPL_LOOP --></div>
<!-- /TMPL_LOOP -->
</div>	
		<div name="hidden" id="hidden" class="tab">
		<!-- TMPL_LOOP NAME="hidden_loop" -->
				<input type="hidden" name="tag" value="<!-- TMPL_VAR NAME="tag" -->">
				<input type="hidden" name="subfield" value="<!-- TMPL_VAR NAME="subfield" -->">
				<input type="hidden" name="mandatory" value="<!-- TMPL_VAR NAME="mandatory" -->">
				<input type="hidden" name="kohafield" value="<!-- TMPL_VAR NAME="kohafield" -->">
				<input type="hidden" name="tag_mandatory" value="<!-- TMPL_VAR NAME="tag_mandatory" -->">
		<!-- /TMPL_LOOP -->
		</div>
		<!-- TMPL_IF name="oldauthnumtagfield" -->
			<input type="hidden" name="tag" value="<!-- TMPL_VAR NAME="oldauthnumtagfield" -->">
			<input type="hidden" name="subfield" value="<!-- TMPL_VAR NAME="oldauthnumtagsubfield" -->">
			<input type="hidden" name="field_value" value="<!-- TMPL_VAR NAME="authid" -->">
			<input type="hidden" name="mandatory" value="0">
			<input type="hidden" name="kohafield" value="<!-- TMPL_VAR NAME="kohafield" -->">
			<input type="hidden" name="tag_mandatory" value="<!-- TMPL_VAR NAME="tag_mandatory" -->">
			<input type="hidden" name="tag" value="<!-- TMPL_VAR NAME="oldauthtypetagfield" -->">
			<input type="hidden" name="subfield" value="<!-- TMPL_VAR NAME="oldauthtypetagsubfield" -->">
			<input type="hidden" name="field_value" value="<!-- TMPL_VAR NAME="authtypecode" -->">
		<!-- /TMPL_IF -->
	</form>
<script language="JavaScript" type="text/javascript">
function _(s) { return s } // dummy function for gettext
function active(numlayer)
{
	for (i=0; i < 10 ; i++ ) {
		ong = i+"XX";
		link = "link"+i;
		if (numlayer==i) {
			document.getElementById(ong).style.visibility="visible";
		} else {
			document.getElementById(ong).style.visibility="hidden";
		}
	}
}
function Check(f) {
	// Scan for nonempty fields
	var field_is_nonempty_p = new Array();
	for (i=0 ; i<f.field_value.length ; i++) {
	    field_is_nonempty_p[f.tag[i].value] = 0;
	}
	for (i=0 ; i<f.field_value.length ; i++) {
	    if (f.field_value[i].value.length != 0) {
		field_is_nonempty_p[f.tag[i].value] += 1;
	    }
	}

	// Scan for missing mandatory subfields
	var total_missing_mandatory_subfields = 0;
	for (i=0 ; i<f.field_value.length-2 ; i++) {
		if (f.field_value[i].value.length==0 && f.mandatory[i].value==1) {
		    // We should not flag an error unless the tag is also
		    // mandatory, or if something else in the tag is entered

		    if (f.tag_mandatory[i].value == 1 || field_is_nonempty_p[f.tag[i].value]) {
			document.getElementById("error"+i).style.backgroundColor="#FF0000";
			total_missing_mandatory_subfields++;
		    }
		} else {
			document.getElementById("error"+i).style.backgroundColor="#FFFFFF";
		}
	}

	// Scan for missing mandatory tags
	var total_missing_mandatory_tags = 0;
	var seen_mandatory_tag_p = new Array();
	for (i=0 ; i<f.field_value.length ; i++) {
	    var j = f.tag[i].value;
	    if (!field_is_nonempty_p[j] && f.tag_mandatory[i].value == 1) {
		if (seen_mandatory_tag_p[j] != 1) {
		    seen_mandatory_tag_p[j] = 1;
		    total_missing_mandatory_tags++;
		}
		document.getElementById("error"+i).style.backgroundColor="#ffff00";
	    }
	}

	var total_errors = total_missing_mandatory_tags + total_missing_mandatory_subfields;
	var alertString2;
	if (total_errors!=0) {
		alertString2  = _("Form not submitted because of the following problem(s)");
		alertString2 += "\n------------------------------------------------------------------------------------\n";
		alertString2 += "\n- "+ total_missing_mandatory_tags +_(" mandatory tags empty");
		alertString2 += "\n- "+ total_missing_mandatory_subfields +_(" mandatory fields empty (see bold subfields)");
		alert(alertString2);
	} else {
		document.forms['f'].submit();
	}
}
function Dopop(link,i) {
	defaultvalue=document.forms['f'].field_value[i].value;
	newin=window.open(link+"&result="+defaultvalue,"",'width=550,height=550,toolbar=false,scrollbars=yes');
}
function _(s) { return s } // dummy function for gettext
function PopupZ3950() {
    var strQuery="";
	for (i=0 ; i<document.forms[0].field_value.length ; i++) {
		if (document.forms[0].kohafield[i].value == "biblioitems.isbn" && document.forms[0].field_value[i].value.length>0) {
		    strQuery += "&isbn="+document.forms[0].field_value[i].value;
		}
		if (document.forms[0].kohafield[i].value == "biblio.title" && document.forms[0].field_value[i].value.length>0) {
		    strQuery += "&title="+document.forms[0].field_value[i].value;
		}
		if (document.forms[0].kohafield[i].value == "biblio.author" &&document.forms[0].field_value[i].value.length>0) {
		    strQuery += "&author="+document.forms[0].field_value[i].value;
		}
		if (document.forms[0].kohafield[i].value == "biblioitems.issn" && document.forms[0].field_value[i].value.length>0) {
		    strQuery += "&issn="+document.forms[0].field_value[i].value;
		}
	}
	newin=window.open("../z3950/search.pl?bibid=<!-- TMPL_VAR NAME="bibid" -->"+strQuery,"z3950search",'width=500,height=400,toolbar=false,scrollbars=yes');
}
function confirmnotdup(){
	document.getElementById("confirm_not_duplicate").value = 1;
	var checkform =	document.getElementById("f");
	Check(checkform);
}
function AddField(field) {
	document.forms['f'].op.value = "addfield";
	document.forms['f'].addfield_field.value=field;
	document.f.submit();
}
function cloneSubfield(index) {
 var original = document.getElementById(index);
 var clone = original.cloneNode(true);
 clone.setAttribute("id", index + index); 
// orginput : the value of the original field (in [0] if hide_marc=1, otherwise in [1]
// image : the up button. don't exist is hide_marc=1
 <!-- TMPL_IF name="hide_marc" -->
	var orginput = original.getElementsByTagName('input')[0];
 <!-- TMPL_ELSE -->
 	var orginput = original.getElementsByTagName('input')[1];
	image = clone.getElementsByTagName('img')[0];
	image.setAttribute("onclick","upSubfield('" + index + index + "')");
 <!-- /TMPL_IF -->
 trigger = original.getElementsByTagName('a')[0];
 if (trigger) {
 	trigger.parentNode.removeChild(trigger);
 }
 clonetrigger = clone.getElementsByTagName('a')[0];
 clonetrigger.setAttribute("onclick","cloneSubfield('" + index + index + "')");
 clone.setAttribute("tabindex","1");
 orginput.value = '';
 original.parentNode.insertBefore( clone, original.nextSibling); 
}

function upSubfield(index) {
var original = document.getElementById(index);
var previous = original.previousSibling;
original.parentNode.insertBefore( original, previous );
}

function unHideSubfield(index,labelindex) {
	subfield = document.getElementById(index);
	
	subfield.style.display = 'block';
	label = document.getElementById(labelindex);
	label.style.display='none';
	
	
}
</script>
<!-- TMPL_INCLUDE NAME="intranet-bottom.inc" -->